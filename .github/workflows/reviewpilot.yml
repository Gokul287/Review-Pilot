# ReviewPilot CI â€” Automated Code Review on Pull Requests
# This workflow runs ReviewPilot analysis on every PR
# and posts results as a PR comment.

name: ReviewPilot Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    name: ğŸ›©ï¸ AI Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for diff analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install ReviewPilot
        run: npm install -g .

      - name: Run ReviewPilot Analysis
        id: review
        run: |
          reviewpilot check \
            --base ${{ github.base_ref }} \
            --no-copilot \
            --save \
            --no-telemetry \
            2>&1 | tee review-output.txt
        env:
          REVIEWPILOT_TELEMETRY: '0'
        continue-on-error: true

      - name: Post PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read generated artifacts
            let prDesc = '';
            let checklist = '';
            let analysis = null;

            try {
              prDesc = fs.readFileSync('.reviewpilot-output/pr-description.md', 'utf-8');
            } catch { prDesc = '_PR description not generated._'; }

            try {
              checklist = fs.readFileSync('.reviewpilot-output/checklist.md', 'utf-8');
            } catch { checklist = '_Checklist not generated._'; }

            try {
              analysis = JSON.parse(fs.readFileSync('.reviewpilot-output/analysis.json', 'utf-8'));
            } catch { analysis = null; }

            // Build comment body
            const parts = [
              '## ğŸ›©ï¸ ReviewPilot Analysis',
              '',
            ];

            if (analysis) {
              const critical = analysis.findings.filter(f => f.severity === 'critical').length;
              const errors = analysis.findings.filter(f => f.severity === 'error').length;
              const warnings = analysis.findings.filter(f => f.severity === 'warning').length;

              parts.push(`| Metric | Count |`);
              parts.push(`|--------|-------|`);
              parts.push(`| ğŸ”´ Critical | ${critical} |`);
              parts.push(`| ğŸŸ  Errors | ${errors} |`);
              parts.push(`| ğŸŸ¡ Warnings | ${warnings} |`);
              parts.push(`| Total findings | ${analysis.findings.length} |`);
              parts.push('');

              if (analysis.findings.length > 0) {
                parts.push('<details>');
                parts.push('<summary>ğŸ“‹ Findings Details</summary>');
                parts.push('');
                for (const f of analysis.findings.slice(0, 20)) {
                  const icon = f.severity === 'critical' ? 'ğŸ”´' : f.severity === 'error' ? 'ğŸŸ ' : 'ğŸŸ¡';
                  parts.push(`- ${icon} **${f.file}:${f.line}** â€” ${f.message}`);
                }
                if (analysis.findings.length > 20) {
                  parts.push(`- _...and ${analysis.findings.length - 20} more_`);
                }
                parts.push('');
                parts.push('</details>');
              }
            }

            parts.push('');
            parts.push('<details>');
            parts.push('<summary>ğŸ“ Generated PR Description</summary>');
            parts.push('');
            parts.push(prDesc);
            parts.push('');
            parts.push('</details>');
            parts.push('');
            parts.push(checklist);
            parts.push('');
            parts.push('---');
            parts.push('_Generated by [ReviewPilot](https://github.com/Gokul287/Review-Pilot) ğŸ›©ï¸_');

            const body = parts.join('\n');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.body.includes('ğŸ›©ï¸ ReviewPilot Analysis')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Fail on critical issues
        if: steps.review.outcome == 'failure'
        run: |
          echo "âŒ ReviewPilot found critical issues. See PR comment for details."
          exit 1
