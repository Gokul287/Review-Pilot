import { askCopilot } from '../utils/copilot.js';

/**
 * Generates a structured PR description in Markdown from the analysis results.
 *
 * @param {object} params
 * @param {import('../analyzers/diff-processor.js').DiffAnalysis} params.diffAnalysis
 * @param {import('../linters/smart-linter.js').Finding[]} params.findings
 * @param {import('../validators/test-checker.js').TestCoverage} params.testCoverage
 * @param {import('../detectors/breaking-changes.js').BreakingChange[]} params.breakingChanges
 * @param {string} params.branchName
 * @returns {Promise<string>}
 */
export async function generatePRDescription({
    diffAnalysis,
    findings,
    testCoverage,
    breakingChanges,
    branchName,
}) {
    const sections = [];

    // --- Header ---
    sections.push(`## ðŸ“‹ Pull Request: \`${branchName}\``);
    sections.push('');

    // --- Summary ---
    sections.push('### Summary');
    sections.push(
        `This PR modifies **${diffAnalysis.summary.fileCount}** files ` +
        `with **+${diffAnalysis.summary.additions}** additions and ` +
        `**-${diffAnalysis.summary.deletions}** deletions.`
    );
    sections.push('');

    if (diffAnalysis.aiSummary) {
        sections.push(diffAnalysis.aiSummary);
        sections.push('');
    }

    // --- Changes by Category ---
    sections.push('### Changes');
    const byCategory = groupBy(diffAnalysis.files, 'category');
    for (const [category, files] of Object.entries(byCategory)) {
        sections.push(`\n**${capitalize(category)}:**`);
        for (const f of files) {
            const badge = f.type === 'added' ? 'ðŸ†•' : f.type === 'deleted' ? 'ðŸ—‘ï¸' : 'âœï¸';
            sections.push(`- ${badge} \`${f.file}\` (+${f.additions}/-${f.deletions})`);
        }
    }
    sections.push('');

    // --- Breaking Changes ---
    const majorBreaking = breakingChanges.filter((c) => c.severity === 'major');
    if (majorBreaking.length > 0) {
        sections.push('### âš ï¸ Breaking Changes');
        for (const bc of majorBreaking) {
            sections.push(`- **\`${bc.functionName}\`** in \`${bc.file}\`: ${bc.description}`);
        }
        sections.push('');
    }

    // --- Issues Found ---
    const issueCount = findings.filter((f) => f.severity !== 'suggestion').length;
    if (issueCount > 0) {
        sections.push(`### ðŸ” Issues Found (${issueCount})`);
        const bySeverity = groupBy(findings.filter((f) => f.severity !== 'suggestion'), 'severity');
        for (const [severity, items] of Object.entries(bySeverity)) {
            sections.push(`\n**${severity.toUpperCase()}:**`);
            for (const item of items.slice(0, 10)) {
                sections.push(`- \`${item.file}:${item.line}\` â€” ${item.message}`);
            }
        }
        sections.push('');
    }

    // --- Test Coverage ---
    sections.push('### ðŸ§ª Test Coverage');
    if (testCoverage.untestedFiles.length === 0) {
        sections.push('âœ… All changed source files have corresponding test files.');
    } else {
        sections.push(`âš ï¸ **${testCoverage.untestedFiles.length}** file(s) lack test coverage:`);
        for (const f of testCoverage.untestedFiles) {
            sections.push(`- \`${f}\``);
        }
    }
    sections.push('');

    // --- AI Enhancement ---
    const aiDescription = await askCopilot(
        `Write a concise, professional PR description (3-4 sentences) for these changes:\n` +
        `Files: ${diffAnalysis.files.map((f) => f.file).join(', ')}\n` +
        `Summary: ${diffAnalysis.summary.additions} additions, ${diffAnalysis.summary.deletions} deletions\n` +
        `Breaking changes: ${majorBreaking.length}`,
        { timeout: 15000 }
    );

    if (aiDescription) {
        sections.push('### ðŸ¤– AI Summary');
        sections.push(aiDescription);
        sections.push('');
    }

    sections.push('---');
    sections.push('*Generated by [ReviewPilot](https://github.com/reviewpilot) ðŸ›©ï¸*');

    return sections.join('\n');
}

// --- Helpers ---

function groupBy(arr, key) {
    return arr.reduce((acc, item) => {
        const group = item[key] || 'other';
        (acc[group] = acc[group] || []).push(item);
        return acc;
    }, {});
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}
